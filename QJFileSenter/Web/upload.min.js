(function(n){n(function(){function ft(){var n=(new Date).getTime();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var i=(n+Math.random()*16)%16|0;return n=Math.floor(n/16),(t=="x"?i:i&3|8).toString(16)})}function et(i){var r=n('<li id="'+i.id+'"><p class="title">'+i.name+'<\/p><p class="imgWrap"><\/p><p class="progress"><span><\/span><\/p><\/li>'),c=n('<div class="file-panel"><span class="cancel">删除<\/span><span class="rotateRight">向右旋转<\/span><span class="rotateLeft">向左旋转<\/span><\/div>').appendTo(r),e=r.find("p.progress span"),u=r.find("p.imgWrap"),s=n('<p class="error"><\/p>'),f=function(n){switch(n){case"exceed_size":text="文件大小超出";break;case"interrupt":text="上传暂停";break;default:text="上传失败，请重试"}s.text(text).appendTo(r)};i.getStatus()==="invalid"?f(i.statusText):(u.text("预览中"),t.makeThumb(i,function(t,i){if(t){u.text("不能预览");return}var r=n('<img src="'+i+'">');u.empty().append(r)},tt,it),o[i.id]=[i.size,0],i.rotation=0);i.on("statuschange",function(n,t){t==="progress"?e.hide().width(0):t==="queued";n==="error"||n==="invalid"?(console.log(i.statusText),f(i.statusText),o[i.id][1]=1):n==="interrupt"?f("interrupt"):n==="queued"?o[i.id][1]=0:n==="progress"?(s.remove(),e.css("display","block")):n==="complete"&&r.append('<span class="success"><\/span>');r.removeClass("state-"+t).addClass("state-"+n)});c.on("click","span",function(){var f=n(this).index(),r;switch(f){case 0:t.removeFile(i);return;case 1:i.rotation+=90;break;case 2:i.rotation-=90}rt?(r="rotate("+i.rotation+"deg)",u.css({"-webkit-transform":r,"-mos-transform":r,"-o-transform":r,transform:r})):u.css("filter","progid:DXImageTransform.Microsoft.BasicImage(rotation="+~~(i.rotation/90%4+4)%4+")")});r.appendTo(h)}function d(n){window.parent.postMessage(JSON.stringify(n),n.url)}function ot(t){var f=n("#"+t.id),i,u;delete o[t.id];l();f.off().find(".file-panel").off().end().remove();i=JSON.stringify(nt());u={type:"filecomplete",data:i,url:r.url};d(u);window.name=i}function l(){var r=0,t=0,u=v.children(),i;n.each(o,function(n,i){t+=i[0];r+=i[0]*i[1]});i=t?r/t:0;u.eq(0).text(Math.round(i*100)+"%");u.eq(1).css("width",Math.round(i*100)+"%");g()}function g(){var r="",n;i==="ready"?r="选中"+e+"个文件，共"+WebUploader.formatSize(y)+"。":i==="confirm"?(n=t.getStats(),n.uploadFailNum&&(r="已成功上传"+n.successNum+"个文件至文件库，"+n.uploadFailNum+'个文件上传失败，<a class="retry" href="#">重新上传<\/a>失败文件')):(n=t.getStats(),r="共"+e+"个（"+WebUploader.formatSize(y)+"），已上传"+n.successNum+"个",n.uploadFailNum&&(r+="，失败"+n.uploadFailNum+"个"));b.html(r)}function s(r){var e;if(r!==i){f.removeClass("state-"+i);f.addClass("state-"+r);i=r;switch(i){case"pedding":w.removeClass("element-invisible");h.parent().removeClass("filled");h.hide();u.addClass("element-invisible");t.refresh();break;case"ready":w.addClass("element-invisible");n("#filePicker2").removeClass("element-invisible");h.parent().addClass("filled");h.show();u.removeClass("element-invisible");t.refresh();break;case"uploading":n("#filePicker2").addClass("element-invisible");v.show();f.text("暂停上传");break;case"paused":v.show();f.text("继续上传");break;case"confirm":if(v.hide(),e=t.getStats(),e.successNum&&!e.uploadFailNum){s("finish");return}break;case"finish":n("#filePicker2").removeClass("element-invisible");e=t.getStats();e.successNum?(p.removeClass("element-invisible"),p.text("上传成功"),setTimeout(function(){p.addClass("element-invisible")},3e3)):(i="done",location.reload())}g()}}function nt(){var t=[];return n(".state-complete").each(function(){var i=n(this).find(".md5").text(),r=n(this).find(".filename").text(),u=n(this).find(".filesize").text(),f=n(this).find(".zyid").text();t.push({filename:r,md5:i,filesize:u,zyid:f})}),t}function st(){t.addButton({id:"#filePicker2",label:"继续添加"});t.onUploadProgress=function(t,i){var r=n("#"+t.id),u=r.find(".progress span");u.css("width",i*100+"%");o[t.id][1]=i;l()};t.onFileQueued=function(n){e++;y+=n.size;e===1&&(w.addClass("element-invisible"),u.show());et(n);s("ready");l()};t.onFileDequeued=function(n){e--;y-=n.size;e||s("pedding");ot(n);l()};t.on("all",function(n){switch(n){case"uploadFinished":s("confirm");break;case"startUpload":s("uploading");break;case"stopUpload":s("paused")}});t.onError=function(n){var t=n;switch(n){case"F_DUPLICATE":t="已重复添加该文件.";break;case"UPLOAD_ERROR":t="上传出错.";break;case"Q_TYPE_DENIED":t="类型不匹配或上传文件大小为0.";break;case"Q_EXCEED_NUM_LIMIT":t="超过上传数量限制.";break;case"Q_EXCEED_SIZE_LIMIT":t="超过上传大小限制."}alert("Error: "+t)};f.on("click",function(){if(n(this).hasClass("disabled"))return!1;i==="ready"?t.upload():i==="paused"?t.upload():i==="uploading"&&t.stop(!0)});t.on("uploadSuccess",function(t,i){var u=n("#"+t.id),f,e;u.append('<span class = "filename">'+t.name+"<\/span>");u.append('<span class = "filesize" >'+t.size+"<\/span>");i&&i.split(",").length>1&&u.append('<span class = "zyid" >'+i.split(",")[1]+"<\/span>");f=JSON.stringify(nt());e={type:"filecomplete",data:f,url:r.url};d(e);window.name=f});b.on("click",".retry",function(){t.retry()});f.addClass("state-"+i);l()}var a=n("#uploader"),h=n('<ul class="filelist"><\/ul>').appendTo(a.find(".queueList")),u=a.find(".statusBar"),b=u.find(".info"),p=u.find(".tips"),f=a.find(".uploadBtn"),w=a.find(".placeholder"),v=u.find(".progress").hide(),e=0,y=0,k=window.devicePixelRatio||1,tt=110*k,it=110*k,i="pedding",o={},rt=function(){var n=document.createElement("p").style,t="transition"in n||"WebkitTransition"in n||"MozTransition"in n||"msTransition"in n||"OTransition"in n;return n=null,t}(),t;if(!WebUploader.Uploader.support()){alert("Web Uploader 不支持您的浏览器！如果你使用的是IE浏览器，请尝试升级 flash 播放器");throw new Error("WebUploader does not support the browser you are using.");}var ut={pick:{id:"#filePicker",label:"点击选择文件"},dnd:"#uploader .queueList",paste:document.body,swf:"../Web/webuploader-0.1.5/Uploader.swf",auto:!0,disableGlobalDnd:!0,chunked:!0,chunkSize:1024e3,server:"/document/fileupload",fileNumLimit:300,fileSizeLimit:2147483648,fileSingleSizeLimit:1073741824,compress:!1,formData:{guid:ft(),code:"",secret:"",upinfo:""}},r={},c={};window.addEventListener("message",function(i){i.data!=null&&JSON.parse(i.data).source==="qj-upload"&&(r=JSON.parse(i.data),r.webupconfig&&(c=n.extend(ut,JSON.parse(r.webupconfig)),c.formData.code=r.usercode,c.formData.secret=r.secret,c.formData.upinfo=r.upinfo),n.post("/document/checkauth",{code:r.usercode,secret:r.secret},function(n){n=="Y"?(t=WebUploader.create(c),st()):alert("secret有误,请检查后再上传")}))})});WebUploader.Uploader.register({"before-send-file":"beforeSendFile","before-send":"beforeSend","after-send-file":"afterSendFile"},{beforeSendFile:function(t){var i=this,u=this.owner,f=i.options.server,r=WebUploader.Deferred();return u.md5File(t.source,0,10485760).fail(function(){r.reject()}).then(function(e){n.post(f+"/checkwholefile",{md5:e,code:i.options.formData.code,secret:i.options.formData.secret},function(i){var f=n("#"+t.id);i.result==!0?(u.skipFile(t),i.zyid&&f.append('<span  class = "zyid">'+i.zyid+"<\/span>")):(t.wholeMd5=e,t.chunkMd5s=i.chunkMd5s);r.resolve();f.append('<span  class = "md5">'+e+"<\/span>")})}),r.promise()},beforeSend:function(n){var f=this,r=this.owner,o=f.options.server,i=WebUploader.Deferred(),e=n.blob,t=n.file,s=n.chunk,u=n.chunks,h=n.start,c=n.end,l=n.total;return t.chunks=u,u>1?r.md5File(e).progress(function(){}).then(function(r){var u,f,e;if(n.chunkMd5=r,u=t.chunkMd5s,f=!1,typeof u=="undefined")f=!1;else for(e=0;e<u.length;e++)if(r==u[e]){f=!0;break}f?i.reject():i.resolve()}):(n.chunkMd5=t.wholeMd5,r.options.formData.chunkMd5=t.wholeMd5,i.resolve()),r.options.formData.fileMd5=t.wholeMd5,i.promise()},afterSendFile:function(t){var i=this,u=i.options.server,f=t.name,e=t.ext,r=n.Deferred(),o=t.wholeMd5,s=t.chunks;return s>1?n.ajax({cache:!1,async:!0,type:"post",dataType:"json",url:u+"/fileMerge",data:{fileMd5:o,ext:e,name:f,contentType:t.type,code:i.options.formData.code,secret:i.options.formData.secret,upinfo:i.options.formData.upinfo},success:function(i){if(i.result){if(r.resolve(),i.zyid){var u=n("#"+t.id);u.append('<span  class = "zyid">'+i.zyid+"<\/span>")}}else r.reject()}}):r.resolve(),r.promise()}})})(jQuery);
//# sourceMappingURL=upload.min.js.map
